<div class="toolbar">
  <button (click)="mostraFormAggiunta = true" class="aggiungi-button">Aggiungi</button>
  <button (click)="onSearch()" class="search-button">Cerca</button>
  <button *ngIf="ricercaAttiva" (click)="resetSearch()" class="reset-button">Ripristina</button>
  <input
    type="text"
    [(ngModel)]="searchTerm"
    (keyup.enter)="onSearch()"
    placeholder="Cerca per nome..."
    class="search-input"
  />
</div>

<div *ngIf="mostraFormAggiunta" class="aggiunta-form">
  <form (ngSubmit)="aggiungiMenu()">
    <label>Nome:
      <input type="text" [(ngModel)]="nuovaVoce.nome" name="nome" required />
    </label>
    <label>Prezzo:
      <input type="number" [(ngModel)]="nuovaVoce.prezzo" name="prezzo" required />
    </label>
    <label>Quantità:
      <input type="number" [(ngModel)]="nuovaVoce.quantita" name="quantita" required min="0" />
    </label>
    <label>Tipologia:
      <select [(ngModel)]="nuovaVoce.tipologia_id" name="tipologia_id" required>
        <option *ngFor="let tipo of tipologie" [value]="tipo.id">{{ tipo.descrittivo }}</option>
      </select>
    </label>
    <button type="submit">Invia</button>
    <button type="button" (click)="mostraFormAggiunta = false">Annulla</button>
  </form>
</div>

<table *ngIf="(ricercaAttiva ? filteredItems : menuItems).length > 0">
  <thead>
    <tr>
      <th (click)="onSort('nome')">
        Nome <span *ngIf="sortKey==='nome'">{{ sortDir===1 ? '▲' : '▼' }}</span>
      </th>
      <th (click)="onSort('tipologia')">
        Tipologia <span *ngIf="sortKey==='tipologia'">{{ sortDir===1 ? '▲' : '▼' }}</span>
      </th>
      <th (click)="onSort('prezzo')">
        Prezzo <span *ngIf="sortKey==='prezzo'">{{ sortDir===1 ? '▲' : '▼' }}</span>
      </th>
      <th (click)="onSort('quantita')">
        Quantità <span *ngIf="sortKey==='quantita'">{{ sortDir===1 ? '▲' : '▼' }}</span>
      </th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr
      *ngFor="let item of (ricercaAttiva ? filteredItems : menuItems)"
      [class.highlight]="ricercaAttiva && item.nome.toLowerCase().includes(searchTerm.toLowerCase())"
    >
      <td>{{ item.nome }}</td>
      <td>{{ item.tipologia }}</td>
      <td>{{ item.prezzo | currency: 'EUR' }}</td>
      <td>{{ item.quantita }}</td>
      <td class="actions">
        <button (click)="Modifica(item)">Modifica</button>
        <button (click)="Rimuovi(item.id)">Cancella</button>
      </td>
    </tr>
  </tbody>
</table>
<p *ngIf="(ricercaAttiva ? filteredItems : menuItems).length === 0">
  Nessun elemento nel menu.
</p>

<div *ngIf="selectedItem" class="edit-overlay" (click)="annullaModifica()">
  <div class="edit-form" (click)="$event.stopPropagation()">
    <h3>Modifica voce di menu</h3>
    <form (ngSubmit)="salvaModifiche()">
      <label>Nome:
        <input type="text" [(ngModel)]="selectedItem.nome" name="nome" required />
      </label>
      <label>Prezzo:
        <input type="number" [(ngModel)]="selectedItem.prezzo" name="prezzo" required />
      </label>
      <label>Quantità:
        <input type="number" [(ngModel)]="selectedItem.quantita" name="quantita" required min="0" />
      </label>
      <label>Tipologia:
        <select [(ngModel)]="selectedItem.tipologia_id" name="tipologia_id" required>
          <option *ngFor="let tipo of tipologie" [value]="tipo.id">{{ tipo.descrittivo }}</option>
        </select>
      </label>
      <button type="submit">Salva</button>
      <button type="button" (click)="annullaModifica()">Annulla</button>
    </form>
  </div>
</div>
